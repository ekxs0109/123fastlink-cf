<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç½‘ç›˜ç§’ä¼ JSONç”Ÿæˆå™¨</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      padding: 20px; 
    }
    .container { 
      max-width: 900px; 
      margin: 0 auto; 
      background: white; 
      border-radius: 16px; 
      box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
      padding: 40px; 
    }
    h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
    .subtitle { color: #666; margin-bottom: 30px; font-size: 14px; }
    .info-box { 
      background: #e7f3ff; 
      border-left: 4px solid #2196F3; 
      padding: 12px 16px; 
      margin-bottom: 20px; 
      border-radius: 4px; 
      font-size: 13px; 
      color: #333; 
    }
    .form-group { margin-bottom: 20px; }
    label { 
      display: block; 
      margin-bottom: 8px; 
      color: #333; 
      font-weight: 500; 
      font-size: 14px; 
    }
    .label-with-hint { display: flex; justify-content: space-between; align-items: center; }
    .hint { font-size: 12px; color: #999; font-weight: normal; }
    input, textarea, select { 
      width: 100%; 
      padding: 12px; 
      border: 2px solid #e0e0e0; 
      border-radius: 8px; 
      font-size: 14px; 
      font-family: inherit; 
      transition: border-color 0.3s;
    }
    input:focus, textarea:focus, select:focus { outline: none; border-color: #667eea; }
    textarea { resize: vertical; min-height: 120px; }
    select { cursor: pointer; background: white; }
    .auto-parse-btn {
      margin-top: 10px;
      padding: 8px 16px;
      background: #2196F3;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .auto-parse-btn:hover { background: #1976D2; }
    .detected-info {
      margin-top: 10px;
      padding: 10px;
      background: #f0f8ff;
      border-radius: 6px;
      font-size: 13px;
      display: none;
    }
    .detected-info.show { display: block; }
    .detected-info .type-badge {
      display: inline-block;
      padding: 2px 8px;
      background: #28a745;
      color: white;
      border-radius: 12px;
      font-size: 12px;
      margin-right: 8px;
    }
    button.primary { 
      width: 100%; 
      padding: 14px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
      border: none; 
      border-radius: 8px; 
      font-size: 16px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: transform 0.2s, box-shadow 0.2s;
    }
    button.primary:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4); }
    button.primary:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .result { 
      margin-top: 20px; 
      padding: 15px; 
      background: #f8f9fa; 
      border-radius: 8px; 
      display: none; 
    }
    .result.show { display: block; }
    .result.success { background: #d4edda; border-left: 4px solid #28a745; }
    .result.error { background: #f8d7da; border-left: 4px solid #dc3545; }
    .result-text { 
      word-break: break-all; 
      color: #333; 
      white-space: pre-wrap; 
      font-family: monospace; 
      font-size: 12px; 
      max-height: 400px; 
      overflow-y: auto; 
    }
    .copy-btn { 
      margin-top: 10px; 
      width: auto; 
      padding: 8px 16px; 
      background: #28a745; 
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px; 
      cursor: pointer;
    }
    .cookie-saved {
      display: inline-block;
      margin-left: 10px;
      padding: 4px 10px;
      background: #28a745;
      color: white;
      border-radius: 12px;
      font-size: 12px;
      font-weight: normal;
    }
    .clear-cookie {
      margin-left: 10px;
      padding: 2px 8px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 11px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>âš¡ ç½‘ç›˜ç§’ä¼ JSONç”Ÿæˆå™¨</h1>
    <p class="subtitle">æ”¯æŒ 123ç½‘ç›˜ã€189ç½‘ç›˜ã€å¤¸å…‹ç½‘ç›˜ - æ™ºèƒ½è¯†åˆ«ç½‘ç›˜ç±»å‹</p>
    
    <div class="info-box">
      ğŸ’¡ <strong>ä½¿ç”¨æç¤ºï¼š</strong>ç²˜è´´å®Œæ•´åˆ†äº«æ–‡æœ¬è‡ªåŠ¨è§£æï¼Œæˆ–æ‰‹åŠ¨é€‰æ‹©ç½‘ç›˜ç±»å‹å¹¶å¡«å†™ä¿¡æ¯
    </div>

    <div class="form-group">
      <label>å¿«é€Ÿè§£æï¼ˆç²˜è´´å®Œæ•´åˆ†äº«æ–‡æœ¬ï¼‰</label>
      <textarea id="share-text" placeholder="ç²˜è´´å®Œæ•´çš„åˆ†äº«æ–‡æœ¬ï¼Œä¾‹å¦‚ï¼š

æˆ‘ç”¨å¤¸å…‹ç½‘ç›˜åˆ†äº«äº†ã€Œæ–‡ä»¶åã€
é“¾æ¥ï¼šhttps://pan.quark.cn/s/xxxxx
æå–ç ï¼šxxxx

æˆ–è€…ç›´æ¥ç²˜è´´é“¾æ¥"></textarea>
      <div id="detected-info" class="detected-info"></div>
    </div>

    <div class="form-group">
      <label>ç½‘ç›˜ç±»å‹</label>
      <select id="pan-type" onchange="onPanTypeChange()">
        <option value="">-- è¯·é€‰æ‹©ç½‘ç›˜ç±»å‹ --</option>
        <option value="123">123ç½‘ç›˜</option>
        <option value="189">189ç½‘ç›˜</option>
        <option value="quark">å¤¸å…‹ç½‘ç›˜</option>
      </select>
    </div>

    <div class="form-group">
      <label>åˆ†äº«é“¾æ¥</label>
      <input type="text" id="share-url" placeholder="ä¾‹å¦‚ï¼šhttps://pan.quark.cn/s/xxxxx">
    </div>

    <div class="form-group">
      <label>æå–ç ï¼ˆé€‰å¡«ï¼‰</label>
      <input type="text" id="share-password" placeholder="å¦‚æœ‰æå–ç è¯·è¾“å…¥">
    </div>

    <div class="form-group" id="cookie-group" style="display:none;">
      <div class="label-with-hint">
        <label>
          å¤¸å…‹ç½‘ç›˜Cookieï¼ˆå¿…å¡«ï¼‰
          <span id="cookie-saved-badge" class="cookie-saved" style="display:none;">âœ“ å·²ä¿å­˜</span>
        </label>
        <span class="hint">
          <button class="clear-cookie" id="clear-cookie-btn" style="display:none;" onclick="clearCookie()">æ¸…é™¤</button>
          <a href="#" onclick="showCookieHelp(); return false;" style="color: #667eea; text-decoration: none;">å¦‚ä½•è·å–?</a>
        </span>
      </div>
      <textarea id="quark-cookie" rows="3" placeholder="ç™»å½• https://pan.quark.cnï¼ŒæŒ‰F12æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œåœ¨Networkæ ‡ç­¾ä¸­æ‰¾åˆ°ä»»æ„è¯·æ±‚çš„Cookie"></textarea>
    </div>

    <button class="primary" id="generate-btn" onclick="generate()">ç”Ÿæˆç§’ä¼ JSON</button>
    <div id="result" class="result"></div>
  </div>

  <script>
    // é˜²æŠ–å‡½æ•°
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // æ£€æµ‹ç½‘ç›˜ç±»å‹
    function detectPanType(text) {
      // å…ˆè§£ç URL
      try {
        text = decodeURIComponent(text);
      } catch (e) {
        // å¦‚æœè§£ç å¤±è´¥ï¼Œä½¿ç”¨åŸå§‹æ–‡æœ¬
        console.log('URL decode failed, using original text');
      }
      
      const detections = {
        '123': {
          urlRegex: /https?:\/\/(?:www\.)?123(?:\d+|pan)\.\w+\/s\/([a-zA-Z0-9\-]+)/,
          pwdRegex: /(?:æå–ç |å¯†ç |è®¿é—®ç )[ï¼š:\s]*([a-zA-Z0-9]{4})/,
          name: '123ç½‘ç›˜'
        },
        '189': {
          urlRegex: /https?:\/\/cloud\.189\.cn\/(?:t\/([a-zA-Z0-9]+)|web\/share\?code=([a-zA-Z0-9]+))/,
          pwdRegex: /(?:æå–ç |è®¿é—®ç )[ï¼š:\s]*([a-zA-Z0-9]+)/,
          name: '189ç½‘ç›˜'
        },
        'quark': {
          urlRegex: /https?:\/\/pan\.quark\.cn\/s\/([a-zA-Z0-9]+)/,
          pwdRegex: /(?:æå–ç |å¯†ç )[ï¼š:\s]*([a-zA-Z0-9]+)/,
          name: 'å¤¸å…‹ç½‘ç›˜'
        }
      };

      for (const [type, config] of Object.entries(detections)) {
        const urlMatch = text.match(config.urlRegex);
        if (urlMatch) {
          let password = '';
          
          // 1. é¦–å…ˆå°è¯•ä»URLå‚æ•°ä¸­æå–å¯†ç  (?pwd=xxxx)
          const urlPwdMatch = text.match(/[?&]pwd=([a-zA-Z0-9]+)/);
          if (urlPwdMatch) {
            password = urlPwdMatch[1];
          } else {
            // 2. å¦‚æœURLå‚æ•°ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»æ–‡æœ¬ä¸­æå–
            const pwdMatch = text.match(config.pwdRegex);
            if (pwdMatch) {
              password = pwdMatch[1];
            }
          }
          
          // For 189, we have two possible capture groups (t/xxx or ?code=xxx)
          const shareKey = type === '189' ? (urlMatch[1] || urlMatch[2]) : urlMatch[1];
          return {
            type,
            name: config.name,
            url: urlMatch[0],
            shareKey,
            password: password,
            needsCookie: type === 'quark'
          };
        }
      }
      return null;
    }

    // è‡ªåŠ¨è§£æ
    function autoParse() {
      const text = document.getElementById('share-text').value.trim();
      const detectedDiv = document.getElementById('detected-info');
      
      if (!text) {
        showResult(document.getElementById('result'), 'è¯·è¾“å…¥åˆ†äº«å†…å®¹', 'error');
        return;
      }

      const detected = detectPanType(text);
      if (detected) {
        // å¡«å……è¡¨å•
        document.getElementById('pan-type').value = detected.type;
        document.getElementById('share-url').value = detected.url;
        document.getElementById('share-password').value = detected.password;
        
        // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
        let html = `<span class="type-badge">âœ“ å·²è¯†åˆ«</span>`;
        html += `${detected.name} | é“¾æ¥: ${detected.url}`;
        if (detected.password) {
          html += ` | æå–ç : ${detected.password}`;
        }
        detectedDiv.innerHTML = html;
        detectedDiv.classList.add('show');
        
        // å¤„ç†Cookieæ˜¾ç¤º
        onPanTypeChange();
      } else {
        detectedDiv.innerHTML = '<span style="color: #dc3545;">âŒ æœªè¯†åˆ«åˆ°æœ‰æ•ˆçš„ç½‘ç›˜é“¾æ¥</span>';
        detectedDiv.classList.add('show');
      }
    }

    // ç½‘ç›˜ç±»å‹å˜åŒ–
    function onPanTypeChange() {
      const type = document.getElementById('pan-type').value;
      const cookieGroup = document.getElementById('cookie-group');
      
      if (type === 'quark') {
        cookieGroup.style.display = 'block';
        loadSavedCookie();
      } else {
        cookieGroup.style.display = 'none';
      }
    }

    // Cookieç®¡ç†
    function saveCookie(cookie) {
      localStorage.setItem('quark_cookie', cookie);
      showCookieSavedBadge();
    }

    function loadSavedCookie() {
      const saved = localStorage.getItem('quark_cookie');
      const cookieInput = document.getElementById('quark-cookie');
      if (saved) {
        cookieInput.value = saved;
        showCookieSavedBadge();
      }
    }

    function showCookieSavedBadge() {
      const badge = document.getElementById('cookie-saved-badge');
      const clearBtn = document.getElementById('clear-cookie-btn');
      badge.style.display = 'inline-block';
      clearBtn.style.display = 'inline-block';
    }

    function clearCookie() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤ä¿å­˜çš„Cookieå—ï¼Ÿ')) {
        localStorage.removeItem('quark_cookie');
        document.getElementById('quark-cookie').value = '';
        document.getElementById('cookie-saved-badge').style.display = 'none';
        document.getElementById('clear-cookie-btn').style.display = 'none';
      }
    }

    // Cookieè¾“å…¥æ¡†å¤±ç„¦æ—¶ä¿å­˜
    document.getElementById('quark-cookie').addEventListener('blur', function() {
      const cookie = this.value.trim();
      if (cookie) {
        saveCookie(cookie);
      }
    });

    // æ˜¾ç¤ºCookieè·å–å¸®åŠ©
    function showCookieHelp() {
      alert('è·å–å¤¸å…‹Cookieæ­¥éª¤ï¼š\n\n1. æ‰“å¼€ https://pan.quark.cn å¹¶ç™»å½•\n2. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·\n3. åˆ‡æ¢åˆ° Network (ç½‘ç»œ) æ ‡ç­¾\n4. åˆ·æ–°é¡µé¢\n5. ç‚¹å‡»ä»»æ„è¯·æ±‚\n6. åœ¨ Request Headers ä¸­æ‰¾åˆ° Cookie\n7. å¤åˆ¶å®Œæ•´çš„ Cookie å€¼\n\næç¤ºï¼šCookieä¼šè‡ªåŠ¨ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°');
    }

    // ç”Ÿæˆç§’ä¼ JSON
    async function generate() {
      const panType = document.getElementById('pan-type').value;
      const shareUrl = document.getElementById('share-url').value.trim();
      const sharePassword = document.getElementById('share-password').value.trim();
      const btn = document.getElementById('generate-btn');
      const result = document.getElementById('result');

      if (!panType) {
        showResult(result, 'è¯·é€‰æ‹©ç½‘ç›˜ç±»å‹', 'error');
        return;
      }

      if (!shareUrl) {
        showResult(result, 'è¯·è¾“å…¥åˆ†äº«é“¾æ¥', 'error');
        return;
      }

      // æ£€æŸ¥å¤¸å…‹ç½‘ç›˜æ˜¯å¦æœ‰Cookie
      if (panType === 'quark') {
        const cookie = document.getElementById('quark-cookie').value.trim();
        if (!cookie) {
          showResult(result, 'å¤¸å…‹ç½‘ç›˜éœ€è¦æä¾›Cookie', 'error');
          return;
        }
      }

      btn.disabled = true;
      btn.textContent = 'ç”Ÿæˆä¸­...';

      try {
        let requestBody = {};
        
        if (panType === 'quark') {
          const cookie = document.getElementById('quark-cookie').value.trim();
          requestBody = { shareUrl, sharePassword, cookie };
        } else {
          requestBody = { shareUrl, sharePassword };
        }

        const res = await fetch('/api/' + panType + '/rapid', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestBody)
        });

        const data = await res.json();
        if (data.success) {
          const json = JSON.stringify(data.rapidTransferJson, null, 2);
          const panNames = {'123': '123ç½‘ç›˜', '189': '189ç½‘ç›˜', 'quark': 'å¤¸å…‹ç½‘ç›˜'};
          showResult(result, `[${panNames[panType]}] ç§’ä¼ JSONå·²ç”Ÿæˆï¼š\n\n${json}`, 'success', json);
        } else {
          showResult(result, `ç”Ÿæˆå¤±è´¥: ${data.error}`, 'error');
        }
      } catch (error) {
        showResult(result, `è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'ç”Ÿæˆç§’ä¼ JSON';
      }
    }

    function showResult(el, msg, type, copyText) {
      el.className = 'result show ' + type;
      el.innerHTML = '<div class="result-text">' + msg + '</div>';
      
      if (copyText) {
        const btn = document.createElement('button');
        btn.className = 'copy-btn';
        btn.textContent = 'ğŸ“‹ å¤åˆ¶JSON';
        btn.onclick = function() {
          navigator.clipboard.writeText(copyText);
          btn.textContent = 'âœ… å·²å¤åˆ¶';
          setTimeout(() => btn.textContent = 'ğŸ“‹ å¤åˆ¶JSON', 2000);
        };
        el.appendChild(btn);
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      const shareTextArea = document.getElementById('share-text');
      
      // åˆ›å»ºé˜²æŠ–çš„è‡ªåŠ¨è§£æå‡½æ•°ï¼ˆ500mså»¶è¿Ÿï¼‰
      const debouncedAutoParse = debounce(function() {
        const text = shareTextArea.value.trim();
        if (text) {
          autoParse();
        }
      }, 500);
      
      // ç›‘å¬è¾“å…¥å’Œç²˜è´´äº‹ä»¶
      shareTextArea.addEventListener('input', debouncedAutoParse);
      shareTextArea.addEventListener('paste', function() {
        // ç²˜è´´åç¨å¾®å»¶è¿Ÿï¼Œç¡®ä¿å†…å®¹å·²ç»å¡«å……
        setTimeout(debouncedAutoParse, 100);
      });
    });
  </script>
</body>
</html>
