// ==UserScript==
// @name         夸克网盘秒传JSON生成器
// @namespace    http://tampermonkey.net/
// @version      1.0.3
// @description  在夸克网盘生成秒传JSON文件（含MD5），支持递归获取文件夹
// @author       Your Name
// @match        https://pan.quark.cn/*
// @match        https://drive.quark.cn/*
// @grant        GM_setClipboard
// @grant        GM_notification
// @grant        GM_xmlhttpRequest
// @run-at       document-end
// @connect      drive.quark.cn
// @connect      drive-pc.quark.cn
// ==/UserScript==

(function() {
    'use strict';

    // 工具函数
    const utils = {
        // 延迟函数
        sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        },

        // 查找 React Fiber 节点
        findReact(dom, traverseUp = 0) {
            console.log('@@@@ findReact 开始, dom:', dom);
            let key = Object.keys(dom).find(key => {
                return key.startsWith("__reactFiber$") || key.startsWith("__reactInternalInstance$");
            });
            console.log('@@@@ 找到的 React key:', key);
            
            let domFiber = dom[key];
            console.log('@@@@ domFiber:', domFiber);
            
            if (domFiber == null) {
                console.log('@@@@ domFiber 为 null');
                return null;
            }
            
            if (domFiber._currentElement) {
                console.log('@@@@ 使用旧版 React');
                let compFiber = domFiber._currentElement._owner;
                for (let i = 0; i < traverseUp; i++) {
                    compFiber = compFiber._currentElement._owner;
                }
                return compFiber._instance;
            }
            
            console.log('@@@@ 使用新版 React Fiber');
            const GetCompFiber = fiber => {
                let parentFiber = fiber.return;
                while (typeof parentFiber.type === "string") {
                    parentFiber = parentFiber.return;
                }
                return parentFiber;
            };
            
            let compFiber = GetCompFiber(domFiber);
            for (let i = 0; i < traverseUp; i++) {
                compFiber = GetCompFiber(compFiber);
            }
            
            console.log('@@@@ 返回的 compFiber:', compFiber);
            return compFiber.stateNode || compFiber;
        },

        // 获取选中的文件列表
        getSelectedList() {
            try {
                console.log('@@@@ getSelectedList 开始');
                const fileListDom = document.getElementsByClassName('file-list')[0];
                console.log('@@@@ fileListDom:', fileListDom);
                
                if (!fileListDom) {
                    console.log('@@@@ fileListDom 不存在');
                    return [];
                }

                const reactObj = this.findReact(fileListDom);
                console.log('@@@@ reactObj:', reactObj);
                
                const props = reactObj?.props;
                console.log('@@@@ props:', props);
                
                if (props) {
                    const fileList = props.list || [];
                    const selectedKeys = props.selectedRowKeys || [];
                    console.log('@@@@ fileList 长度:', fileList.length);
                    console.log('@@@@ selectedKeys:', selectedKeys);
                    console.log('@@@@ fileList 示例:', fileList[0]);
                    
                    const selectedList = [];
                    fileList.forEach(function (val) {
                        if (selectedKeys.includes(val.fid)) {
                            console.log('@@@@ 选中的文件:', val.file_name, '是否是文件:', val.file);
                            selectedList.push(val);
                        }
                    });
                    
                    console.log('@@@@ 最终选中列表长度:', selectedList.length);
                    return selectedList;
                }
                
                console.log('@@@@ props 不存在');
                return [];
            } catch (e) {
                console.error('@@@@ 获取文件列表失败:', e);
                return [];
            }
        },

        // 使用 GM_xmlhttpRequest 发送POST请求
        post(url, data, headers = {}) {
            return new Promise((resolve, reject) => {
                const requestData = JSON.stringify(data);
                // 使用夸克客户端的 User-Agent（重要！）
                const QUARK_UA = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) quark-cloud-drive/2.5.20 Chrome/100.0.4896.160 Electron/18.3.5.4-b478491100 Safari/537.36 Channel/pckk_other_ch";
                const defaultHeaders = {
                    "Content-Type": "application/json;charset=utf-8",
                    "User-Agent": QUARK_UA,
                    "Origin": location.origin,
                    "Referer": `${location.origin}/`,
                    "Dnt": "",
                    "Cache-Control": "no-cache",
                    "Pragma": "no-cache",
                    "Expires": "0"
                };
                
                console.log('@@@@ 发送POST请求');
                console.log('@@@@ URL:', url);
                console.log('@@@@ 请求数据:', data);
                console.log('@@@@ 请求头:', {...defaultHeaders, ...headers});
                
                GM_xmlhttpRequest({
                    method: "POST",
                    url: url,
                    headers: {...defaultHeaders, ...headers},
                    data: requestData,
                    onload: function(response) {
                        console.log('@@@@ 响应状态:', response.status);
                        console.log('@@@@ 响应内容:', response.responseText);
                        try {
                            const result = JSON.parse(response.responseText);
                            resolve(result);
                        } catch (e) {
                            console.error('@@@@ JSON解析失败:', e);
                            reject(new Error('响应解析失败'));
                        }
                    },
                    onerror: function(error) {
                        console.error('@@@@ 请求失败:', error);
                        reject(new Error('网络请求失败'));
                    }
                });
            });
        },

        // 批量获取文件下载信息（含MD5）
        async getFilesWithMd5(fileList, onProgress) {
            const API_URL = "https://drive.quark.cn/1/clouddrive/file/download?pr=ucpro&fr=pc";
            const BATCH_SIZE = 15;

            const data = [];
            let processed = 0;
            const validFiles = fileList.filter(item => item.file === true);

            console.log('@@@@ 开始批量获取文件MD5，总文件数:', validFiles.length);

            for (let i = 0; i < validFiles.length; i += BATCH_SIZE) {
                const batch = validFiles.slice(i, i + BATCH_SIZE);
                const fids = batch.map(item => item.fid);

                console.log('@@@@ 当前批次:', i / BATCH_SIZE + 1, 'fids:', fids);

                try {
                    const result = await this.post(API_URL, { fids });
                    console.log('@@@@ API 返回结果:', result);

                    if (result?.code === 31001) {
                        throw new Error('请先登录网盘');
                    }
                    if (result?.code !== 0) {
                        throw new Error(`获取链接失败，代码：${result.code}，消息：${result.message}`);
                    }

                    if (result?.data) {
                        console.log('@@@@ 本批次获取到', result.data.length, '个文件信息');
                        data.push(...result.data);
                    }

                    processed += batch.length;
                    if (onProgress) {
                        onProgress(processed, validFiles.length);
                    }

                    // 节流
                    await this.sleep(1000);
                } catch (error) {
                    console.error('@@@@ 批量获取失败:', error);
                    throw error;
                }
            }

            console.log('@@@@ 所有文件信息获取完成，总数:', data.length);
            return data;
        },

        // 生成秒传JSON
        generateRapidTransferJson(filesData) {
            const result = filesData.map(file => ({
                file_name: file.file_name,
                size: file.size,
                md5: file.md5,
                fid: file.fid,
                obj_key: file.obj_key,
                format_type: file.format_type,
                category: file.category,
                created_at: file.created_at
            }));

            return {
                version: "1.0.0",
                timestamp: Date.now(),
                total: result.length,
                files: result
            };
        },

        // 显示加载弹窗
        showLoadingDialog(title, message) {
            const existingDialog = document.getElementById('quark-json-loading-dialog');
            if (existingDialog) {
                existingDialog.remove();
            }

            const dialog = document.createElement('div');
            dialog.id = 'quark-json-loading-dialog';
            dialog.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; min-width: 300px; text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">${title}</div>
                        <div id="quark-json-loading-message" style="font-size: 14px; color: #666;">${message}</div>
                        <div style="margin-top: 15px;">
                            <div style="width: 100%; height: 6px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                                <div id="quark-json-progress-bar" style="width: 0%; height: 100%; background: #0d53ff; transition: width 0.3s;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
            return dialog;
        },

        // 更新加载进度
        updateProgress(processed, total) {
            const messageEl = document.getElementById('quark-json-loading-message');
            const progressBar = document.getElementById('quark-json-progress-bar');
            if (messageEl) {
                messageEl.textContent = `已获取 ${processed} / ${total} 个文件信息`;
            }
            if (progressBar) {
                const percent = (processed / total * 100).toFixed(1);
                progressBar.style.width = `${percent}%`;
            }
        },

        // 关闭加载弹窗
        closeLoadingDialog() {
            const dialog = document.getElementById('quark-json-loading-dialog');
            if (dialog) {
                dialog.remove();
            }
        },

        // 显示结果弹窗
        showResultDialog(json) {
            const jsonStr = JSON.stringify(json, null, 2);
            const dialog = document.createElement('div');
            dialog.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; width: 80%; max-width: 800px; max-height: 80vh; display: flex; flex-direction: column;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px;">秒传JSON生成成功</div>
                        <div style="flex: 1; overflow: auto; background: #f5f5f5; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; margin-bottom: 15px;">
                            <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${jsonStr}</pre>
                        </div>
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button id="quark-json-copy-btn" style="padding: 8px 20px; background: #0d53ff; color: white; border: none; border-radius: 4px; cursor: pointer;">复制JSON</button>
                            <button id="quark-json-download-btn" style="padding: 8px 20px; background: #52c41a; color: white; border: none; border-radius: 4px; cursor: pointer;">下载文件</button>
                            <button id="quark-json-close-btn" style="padding: 8px 20px; background: #d9d9d9; color: #333; border: none; border-radius: 4px; cursor: pointer;">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);

            // 复制JSON
            document.getElementById('quark-json-copy-btn').onclick = () => {
                GM_setClipboard(jsonStr);
                GM_notification({
                    text: 'JSON已复制到剪贴板',
                    timeout: 2000
                });
            };

            // 下载文件
            document.getElementById('quark-json-download-btn').onclick = () => {
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `quark_rapid_transfer_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                GM_notification({
                    text: 'JSON文件已下载',
                    timeout: 2000
                });
            };

            // 关闭弹窗
            document.getElementById('quark-json-close-btn').onclick = () => {
                dialog.remove();
            };
        },

        // 显示错误
        showError(message) {
            const dialog = document.createElement('div');
            dialog.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 8px; min-width: 300px; text-align: center;">
                        <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #ff4d4f;">错误</div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 20px;">${message}</div>
                        <button id="quark-json-error-close-btn" style="padding: 8px 30px; background: #d9d9d9; color: #333; border: none; border-radius: 4px; cursor: pointer;">确定</button>
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);

            document.getElementById('quark-json-error-close-btn').onclick = () => {
                dialog.remove();
            };
        }
    };

    // 主要功能
    async function generateJson() {
        console.log('@@@@ generateJson 被调用');
        try {
            // 获取选中的文件
            const selectedFiles = utils.getSelectedList();
            if (selectedFiles.length === 0) {
                utils.showError('请先勾选要生成JSON的文件');
                return;
            }

            const fileCount = selectedFiles.filter(f => f.file === true).length;
            if (fileCount === 0) {
                utils.showError('请选择文件（不支持文件夹）');
                return;
            }

            // 显示加载弹窗
            utils.showLoadingDialog('正在获取文件信息', '准备中...');

            // 获取文件详细信息（含MD5）
            const filesData = await utils.getFilesWithMd5(selectedFiles, (processed, total) => {
                utils.updateProgress(processed, total);
            });

            // 生成JSON
            const json = utils.generateRapidTransferJson(filesData);

            // 关闭加载弹窗
            utils.closeLoadingDialog();

            // 显示结果
            utils.showResultDialog(json);

        } catch (error) {
            utils.closeLoadingDialog();
            utils.showError(error.message || '生成JSON失败');
            console.error('@@@@ 生成JSON错误:', error);
        }
    }

    // 添加按钮
    function addButton() {
        console.log('@@@@ addButton 被调用');
        
        const checkAndAdd = () => {
            console.log('@@@@ 尝试查找容器 .btn-operate .btn-main');
            const container = document.querySelector('.btn-operate .btn-main');
            console.log('@@@@ 找到容器:', container);
            
            if (!container) {
                console.log('@@@@ 容器不存在');
                return false;
            }
            
            if (document.getElementById('quark-json-generator-btn')) {
                console.log('@@@@ 按钮已存在');
                return true;
            }

            console.log('@@@@ 开始创建按钮');
            const button = document.createElement('div');
            button.id = 'quark-json-generator-btn';
            button.className = 'ant-dropdown-trigger pl-button-json';
            button.style.cssText = 'display: inline-block; margin-right: 16px;';
            button.innerHTML = `
                <div class="ant-upload ant-upload-select ant-upload-select-text">
                    <button type="button" class="ant-btn ant-btn-primary" style="background: #52c41a; border-color: #52c41a;">
                        <svg style="width: 16px; height: 16px; margin-right: 4px; vertical-align: -3px;" viewBox="0 0 16 16" fill="currentColor">
                            <path d="M8 2a.5.5 0 0 1 .5.5v5h5a.5.5 0 0 1 0 1h-5v5a.5.5 0 0 1-1 0v-5h-5a.5.5 0 0 1 0-1h5v-5A.5.5 0 0 1 8 2z"/>
                        </svg>
                        <span>生成JSON</span>
                    </button>
                </div>
            `;

            button.querySelector('button').onclick = generateJson;
            console.log('@@@@ 准备插入按钮到容器父级');
            container.parentElement.insertBefore(button, container);
            console.log('@@@@ 按钮已插入');
            return true;
        };
        
        // 轮询检查
        let attempts = 0;
        const interval = setInterval(() => {
            attempts++;
            console.log(`@@@@ 尝试添加按钮 (第 ${attempts} 次)`);
            if (checkAndAdd()) {
                clearInterval(interval);
                console.log('@@@@ 按钮添加成功，停止轮询');
            }
        }, 1000);
        
        // 10秒后停止
        setTimeout(() => {
            clearInterval(interval);
            console.log('@@@@ 停止查找按钮容器（超时）');
        }, 10000);
    }

    // 初始化
    function init() {
        console.log('@@@@ init 被调用');
        console.log('@@@@ 当前路径:', location.pathname);
        
        // 只在列表页面添加按钮
        if (location.pathname.startsWith('/list')) {
            console.log('@@@@ 是列表页面，准备添加按钮');
            addButton();
            
            // 监听路由变化
            let lastUrl = location.href;
            new MutationObserver(() => {
                const url = location.href;
                if (url !== lastUrl) {
                    lastUrl = url;
                    console.log('@@@@ URL 变化:', url);
                    if (location.pathname.startsWith('/list')) {
                        console.log('@@@@ 路由变化到列表页面，重新添加按钮');
                        setTimeout(addButton, 500);
                    }
                }
            }).observe(document.body, { subtree: true, childList: true });
        } else {
            console.log('@@@@ 不是列表页面，不添加按钮');
        }
    }

    // 启动
    console.log('@@@@ 准备启动脚本');
    if (document.readyState === 'loading') {
        console.log('@@@@ 等待 DOMContentLoaded');
        document.addEventListener('DOMContentLoaded', init);
    } else {
        console.log('@@@@ DOM 已就绪，立即初始化');
        init();
    }
})();
